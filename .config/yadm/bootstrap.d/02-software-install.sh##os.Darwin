#!/usr/bin/env bash

# Core Software Installation Script
# Installs essential development tools and applications based on FIXES.md requirements

set -euo pipefail

class=$(yadm config local.class)

# Helper functions for better error handling
install_if_missing() {
    local command_name="$1"
    local install_command="$2"
    local description="$3"

    if ! command -v "$command_name" >/dev/null 2>&1; then
        echo "Installing ${description}..."
        if eval "$install_command"; then
            echo "âœ… Successfully installed ${description}"
        else
            echo "âŒ Failed to install ${description}"
            return 1
        fi
    else
        echo "âœ… ${description} already installed"
    fi
}

install_homebrew_if_missing() {
    if ! command -v brew >/dev/null 2>&1; then
        echo "Installing Homebrew..."
        # Use official Homebrew installer (updated from deprecated Ruby script)
        if /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
            # Add Homebrew to PATH for current session
            if [[ -f "/opt/homebrew/bin/brew" ]]; then
                eval "$(/opt/homebrew/bin/brew shellenv)"
            elif [[ -f "/usr/local/bin/brew" ]]; then
                eval "$(/usr/local/bin/brew shellenv)"
            fi
            echo "âœ… Successfully installed Homebrew"
        else
            echo "âŒ Failed to install Homebrew"
            return 1
        fi
    else
        echo "âœ… Homebrew already installed"
    fi
}

# macOS System Updates (skip for Work machines to avoid interruptions)
if [[ "$class" != "Work" ]]; then
    echo "Checking for macOS system updates..."
    if sudo softwareupdate -i -a; then
        echo "âœ… System updates completed"
    else
        echo "âš ï¸  System updates failed or no updates available"
    fi

    # Install Rosetta for Apple Silicon Macs
    if [[ $(uname -m) == 'arm64' ]]; then
        echo "Installing Rosetta for Apple Silicon..."
        if sudo softwareupdate --install-rosetta --agree-to-license 2>/dev/null; then
            echo "âœ… Rosetta installed successfully"
        else
            echo "âš ï¸  Rosetta installation failed or already installed"
        fi
    fi
fi

# Install Xcode Command Line Tools (includes git and make)
if ! command -v git >/dev/null 2>&1; then
    echo "Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "âš ï¸  Xcode Command Line Tools installation initiated. Please complete the installation and re-run bootstrap."
    exit 1
else
    echo "âœ… Git (Xcode Command Line Tools) already installed"
fi

# Install Homebrew
install_homebrew_if_missing

# Install packages via Brewfile
if [[ -f "${HOME}/.config/yadm/Brewfile" ]]; then
    echo "ğŸ“¦ Installing packages from Brewfile..."
    # Ensure bundle tap is installed
    brew tap homebrew/bundle
    
    if brew bundle install --file="${HOME}/.config/yadm/Brewfile"; then
        echo "âœ… Brewfile installation successful"
    else
        echo "âš ï¸  Some Brewfile packages failed to install"
    fi
else
    echo "âš ï¸  Brewfile not found at ${HOME}/.config/yadm/Brewfile"
fi

# Install mise (version manager)
install_if_missing "mise" "curl https://mise.run | sh" "mise (version manager)"

# Source mise for current session
if [[ -f "${HOME}/.local/bin/mise" ]]; then
    export PATH="${HOME}/.local/bin:${PATH}"
elif [[ -f "${HOME}/.cargo/bin/mise" ]]; then
    export PATH="${HOME}/.cargo/bin:${PATH}"
fi

# Install Rust (prefer rustup, fallback to mise)
echo "Installing/updating Rust..."

if ! command -v rustup >/dev/null 2>&1; then
    echo "Installing Rust via rustup..."
    if curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y; then
        echo "âœ… Rust installed via rustup"
        source "$HOME/.cargo/env"
    else
        echo "âš ï¸  Rustup installation failed. Trying mise..."
        if command -v mise >/dev/null 2>&1; then
            if mise use --global rust@latest; then
                echo "âœ… Rust installed via mise"
            else
                echo "âŒ Failed to install Rust via mise"
            fi
        else
            echo "âŒ Rustup failed and mise is not available"
        fi
    fi
else
    echo "âœ… Rust (rustup) already installed"
    # Ensure cargo is in path
    [[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
    rustup update
fi

# Install cargo-binstall for faster cargo installs
if command -v cargo >/dev/null 2>&1; then
    if ! command -v cargo-binstall >/dev/null 2>&1; then
        echo "Installing cargo-binstall..."
        curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
    else
        echo "âœ… cargo-binstall already installed"
    fi
fi

# Install FZF with shell integrations
if [[ ! -f "${HOME}/.fzf.zsh" ]]; then
    echo "Setting up FZF shell integrations..."
    if brew --prefix fzf >/dev/null 2>&1; then
        FZF_PATH=$(brew --prefix fzf)
        if "${FZF_PATH}/install" --no-update-rc --completion --key-bindings; then
            echo "âœ… FZF shell integrations installed"
        else
            echo "âš ï¸  FZF shell integration setup failed"
        fi
    fi
else
    echo "âœ… FZF shell integrations already configured"
fi

# Update Homebrew and cleanup
echo "Updating Homebrew and cleaning up..."
brew update && brew upgrade && brew cleanup

echo "ğŸ‰ Core software installation completed!"
echo "ğŸ“ Installed applications should now be available in Applications folder and command line tools in PATH"
